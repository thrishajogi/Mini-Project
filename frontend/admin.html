<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZeroBank — Admin Unlock</title>
<link rel="icon" href="data:;base64,=">
<style>
  :root{
    --bg:#f5f6f8; --card:#fff; --muted:#6b7280; --brand:#0a67d1;
    --danger:#ef4444; --ok:#16a34a;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
  body{margin:0;background:var(--bg);padding:28px;color:#111}
  .wrap{max-width:1100px;margin:18px auto}
  .card{background:var(--card);border-radius:10px;padding:18px 20px;box-shadow:0 8px 24px rgba(15,23,42,0.06)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  input[type=text]{padding:10px;border-radius:8px;border:1px solid #e6e6e9;width:360px}
  button{background:var(--brand);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:#f3f4f6;color:#111;border:1px solid #e6e7ea}
  button.danger{background:var(--danger)}
  .small{font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:12px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,1),rgba(250,250,252,1));padding:14px;border-radius:10px;border:1px solid #f0f0f2}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid #f0f0f2;text-align:left}
  th{font-weight:600;color:#374151;background:#fff;position:sticky;top:0}
  .tiny{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  .ok{color:var(--ok);font-weight:600}
  .danger-text{color:var(--danger);font-weight:600}
  .debug{margin-top:12px;padding:10px;background:#fafafa;border:1px dashed #e8e8ea;border-radius:8px;max-height:320px;overflow:auto;font-family:monospace;font-size:12px;color:#111}
  .empty{padding:26px;text-align:center;color:var(--muted)}
  @media (max-width:900px){
    .grid{grid-template-columns:1fr; }
    input[type=text]{width:100%}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Admin — Unlock Accounts</h1>
          <div class="small">Use this page to review recent account lock events and unlock users. Type your <strong>ADMIN_SECRET</strong> before fetching.</div>
        </div>
        <div class="controls">
          <input id="adminSecret" type="text" placeholder="Enter ADMIN_SECRET (not stored)" autocomplete="off" />
          <button id="btnFetch">Fetch locked accounts</button>
          <button id="btnRefresh" class="ghost">Refresh</button>
          <button id="btnClear" class="ghost">Clear</button>
        </div>
      </header>

      <div class="grid">
        <div class="panel" id="leftPanel">
          <div id="status" class="small muted">Status: idle</div>
          <div id="lockedContainer" style="margin-top:12px"></div>
          <div id="emptyNote" class="empty" style="display:none">No locked accounts found in recent events.</div>
        </div>

        <aside class="panel">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <div class="tiny muted">Search locked accounts</div>
              <input id="search" type="text" placeholder="Filter by email..." />
            </div>
            <div style="width:82px;text-align:right">
              <div class="tiny muted">Limit</div>
              <select id="limit">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
              </select>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="tiny muted">Actions</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="unlockAll" class="ghost">Unlock all shown</button>
              <button id="toggleDebug" class="ghost">Toggle debug</button>
            </div>
          </div>

          <div id="counts" style="margin-top:12px" class="small muted">Events: 0 — Locked unique: 0</div>

          <div id="debugBox" class="debug" style="display:none"></div>
        </aside>
      </div>
    </div>
  </div>

<script>
/*
  Admin UI
  - API_BASE must point to your backend
  - Make sure backend is running on http://localhost:5000
*/
const API_BASE = 'http://localhost:5000';

const $ = id => document.getElementById(id);
const statusEl = $('status');
const lockedContainer = $('lockedContainer');
const debugBox = $('debugBox');
const emptyNote = $('emptyNote');
const countsEl = $('counts');

let eventsCache = [];

function setStatus(txt, ok=false) {
  statusEl.textContent = `Status: ${txt}`;
  statusEl.style.color = ok ? 'var(--ok)' : '';
}

function showDebug(obj) {
  debugBox.style.display = 'block';
  try { debugBox.textContent = JSON.stringify(obj, null, 2); } catch(e) { debugBox.textContent = String(obj); }
}

function hideDebug() { debugBox.style.display = 'none'; }

function formatWhen(timeStr) {
  try {
    const d = new Date(timeStr);
    return d.toLocaleString();
  } catch (e) { return timeStr; }
}

function uniqueLockedFromEvents() {
  // find account_locked or login_blocked_locked events
  const locked = eventsCache.filter(e => (e.type === 'account_locked' || e.type === 'login_blocked_locked' || (e.type && e.type.toLowerCase().includes('locked'))));
  const map = {};
  // keep newest event per email
  for (const e of locked) {
    const email = (e.email || (e.details && e.details.email) || '').toLowerCase();
    if (!email) continue;
    if (!map[email] || new Date(e.time) > new Date(map[email].time)) map[email] = e;
  }
  // return array sorted by time desc
  return Object.keys(map).map(email => ({ email, event: map[email] })).sort((a,b)=> new Date(b.event.time) - new Date(a.event.time));
}

function renderLockedList() {
  const list = uniqueLockedFromEvents();
  const filter = $('search').value.trim().toLowerCase();
  const limited = parseInt($('limit').value||'100',10);
  const shown = list.filter(it => !filter || it.email.includes(filter)).slice(0, limited);

  countsEl.textContent = `Events: ${eventsCache.length} — Locked unique: ${list.length} — Showing: ${shown.length}`;

  if (shown.length === 0) {
    lockedContainer.innerHTML = '';
    emptyNote.style.display = 'block';
    return;
  }
  emptyNote.style.display = 'none';

  let html = '<table><thead><tr><th>Email</th><th>When</th><th>Details</th><th></th></tr></thead><tbody>';
  for (const it of shown) {
    const e = it.event;
    const details = (e.details && JSON.stringify(e.details)) || '';
    html += `<tr>
      <td>${it.email}</td>
      <td>${formatWhen(e.time)}</td>
      <td class="tiny">${details}</td>
      <td><button data-email="${it.email}" class="unlockBtn">Unlock</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  lockedContainer.innerHTML = html;

  // attach listeners
  Array.from(document.querySelectorAll('.unlockBtn')).forEach(btn => {
    btn.addEventListener('click', async (ev) => {
      const email = btn.dataset.email;
      await unlockOne(email, btn);
    });
  });
}

async function fetchEvents() {
  const secret = $('adminSecret').value.trim();
  if (!secret) { setStatus('Enter ADMIN_SECRET first'); return; }

  setStatus('Fetching events...');
  hideDebug();
  try {
    const limit = parseInt($('limit').value||'100',10);
    const res = await fetch(`${API_BASE}/admin/events?secret=${encodeURIComponent(secret)}&limit=${limit}`);
    const j = await res.json().catch(()=>null);
    if (!res.ok) {
      setStatus('Error fetching events', false);
      showDebug(j || { status: res.status });
      return;
    }
    eventsCache = j.events || [];
    setStatus('Fetched events', true);
    renderLockedList();
    showDebug({ fetched: eventsCache.length, time: new Date().toISOString() });
  } catch (err) {
    setStatus('Network error while fetching events');
    showDebug({ error: String(err) });
    console.error(err);
  }
}

async function unlockOne(email, btnEl=null) {
  const secret = $('adminSecret').value.trim();
  if (!secret) { setStatus('Enter ADMIN_SECRET first'); return; }
  if (!confirm(`Unlock account ${email}?`)) return;

  try {
    if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'Unlocking...'; }
    const res = await fetch(`${API_BASE}/admin/unlock`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ email, secret })
    });
    const j = await res.json().catch(()=>null);
    if (!res.ok) {
      setStatus('Unlock failed', false);
      showDebug(j || { status: res.status });
      if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Unlock'; }
      return;
    }
    setStatus(`Unlocked ${email}`, true);
    showDebug(j);
    // refresh list
    await fetchEvents();
  } catch (err) {
    setStatus('Network error while unlocking');
    showDebug({ error: String(err) });
    if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Unlock'; }
    console.error(err);
  }
}

async function unlockAllShown() {
  const list = uniqueLockedFromEvents();
  const filter = $('search').value.trim().toLowerCase();
  const limited = parseInt($('limit').value||'100',10);
  const shown = list.filter(it => !filter || it.email.includes(filter)).slice(0, limited);
  if (shown.length === 0) { setStatus('Nothing to unlock'); return; }
  if (!confirm(`Unlock ${shown.length} accounts shown?`)) return;
  for (const it of shown) {
    await unlockOne(it.email);
  }
}

$('btnFetch').addEventListener('click', fetchEvents);
$('btnRefresh').addEventListener('click', fetchEvents);
$('btnClear').addEventListener('click', () => {
  $('search').value = '';
  $('adminSecret').value = '';
  lockedContainer.innerHTML = '';
  eventsCache = [];
  countsEl.textContent = 'Events: 0 — Locked unique: 0';
  setStatus('Cleared');
  hideDebug();
});
$('search').addEventListener('input', renderLockedList);
$('limit').addEventListener('change', renderLockedList);
$('unlockAll').addEventListener('click', unlockAllShown);
$('toggleDebug').addEventListener('click', () => debugBox.style.display = (debugBox.style.display === 'none' ? 'block' : 'none'));

// initial
setStatus('idle');
</script>
</body>
</html>
