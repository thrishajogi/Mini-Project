<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Security Setup (QR) — ZeroBank</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#222;padding:36px;display:flex;justify-content:center}
    .card{width:760px;background:#fff;padding:28px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h1{text-align:center;margin-bottom:8px;font-size:28px}
    .lead{text-align:center;color:#666;margin-bottom:18px}
    label{display:block;margin-top:12px;font-weight:700}
    input[type=text], select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .row{display:flex;gap:20px;margin-top:16px}
    .col{flex:1}
    .qr-wrap{display:flex;align-items:center;gap:18px; padding:12px;border:1px solid #eee;border-radius:6px;background:#fafafa}
    #qrImage{width:260px;height:260px;border:1px solid #ddd;background:#fff}
    .btn{background:#1170e6;color:#fff;padding:12px;border-radius:8px;border:none;font-size:16px;cursor:pointer;margin-top:16px;width:100%}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:13px;margin-top:10px;text-align:center}
    .alert{margin-top:12px;padding:10px;border-radius:6px;display:none}
    .alert.error{background:#fdecea;color:#7b1d1d}
    .alert.ok{background:#e9f7ee;color:#14662f}
    .debug{margin-top:12px;padding:10px;border:1px dashed #e0e0e0;height:140px;overflow:auto;font-family:monospace;font-size:12px;color:#444;background:#fff}
    .small-note{font-size:13px;color:#666;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Security Setup (QR)</h1>
    <p class="lead">Scan the QR with your Authenticator app and enter the current code to complete setup.</p>

    <!-- email (prefilled if available) -->
    <label for="email">Email</label>
    <input id="email" type="text" placeholder="your email (prefilled if you came from signup)">

    <label for="question">Security Question</label>
    <select id="question">
      <option>What was your first pet's name?</option>
      <option>What is your favorite color?</option>
      <option>What is your mother's maiden name?</option>
      <option>What was the name of your elementary school?</option>
      <option>What city were you born in?</option>
    </select>

    <label for="answer">Answer</label>
    <input id="answer" type="text" placeholder="Your answer (will be stored)">

    <div style="margin-top:18px; display:flex; justify-content:center; align-items:flex-start;">
      <div class="qr-wrap" style="width:100%; max-width:720px;">
        <img id="qrImage" src="" alt="Authenticator QR">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:8px">Scan QR with your Authenticator</div>
          <div class="small-note">Open your authenticator app and scan the QR code. After scanning, enter the current 6-digit code below to confirm setup.</div>
        </div>
      </div>
    </div>

    <label for="otpInput">Current authenticator code</label>
    <input id="otpInput" type="text" placeholder="6-digit code (from authenticator)">

    <button id="completeBtn" class="btn">Complete Setup</button>

    <div id="err" class="alert error"></div>
    <div id="ok" class="alert ok"></div>

    <div id="debugBox" class="debug" style="display:none"></div>
  </div>

  <script>
    // ====== CONFIG: change if your backend is not local ======
    const API_BASE = 'http://localhost:5000';

    // ====== Helpers ======
    const el = (id) => document.getElementById(id);
    const showErr = (msg) => { el('err').textContent = msg; el('err').style.display = 'block'; el('ok').style.display='none'; };
    const showOk = (msg) => { el('ok').textContent = msg; el('ok').style.display = 'block'; el('err').style.display='none'; };
    const hideAlerts = () => { el('err').style.display='none'; el('ok').style.display='none'; };

    // Base32 alphabet
    const BASE32_ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

    function randomBase32(length = 16) {
      const bytes = new Uint8Array(length);
      crypto.getRandomValues(bytes);
      // map bytes to base32 chars
      let s = '';
      for (let i=0;i<length;i++){
        s += BASE32_ALPHABET[bytes[i] % 32];
      }
      return s;
    }

    // build otpauth url
    function buildOtpAuth(secretBase32, accountEmail) {
      const label = encodeURIComponent(`ZeroBank:${accountEmail}`);
      const issuer = encodeURIComponent('ZeroBank');
      return `otpauth://totp/${label}?secret=${encodeURIComponent(secretBase32)}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
    }

    function setQRFromOtpAuth(otpauth) {
      // use free QR image generator (no library) — encode the otpauth URL
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=' + encodeURIComponent(otpauth);
      el('qrImage').src = url;
    }

    // debug helper
    function dbg(msg) {
      const box = el('debugBox');
      if (!box) return;
      box.style.display = 'block';
      box.textContent = msg + '\n\n' + box.textContent;
    }

    // ====== Page logic ======
    let currentSecret = ''; // base32 secret (not shown to user)
    let currentEmail = '';

    document.addEventListener('DOMContentLoaded', () => {
      // prefill email if passed from signup/login
      const pending = (sessionStorage.getItem('pendingEmail') || '').trim();
      if (pending) {
        el('email').value = pending;
        currentEmail = pending;
      }

      // generate a secret and QR immediately (one-time)
      currentSecret = randomBase32(16); // 16 characters ~ good length for demo
      // if email not yet set, show placeholder QR for later update
      const initEmail = el('email').value.trim() || 'user@example.com';
      const otpauth = buildOtpAuth(currentSecret, initEmail);
      setQRFromOtpAuth(otpauth);
      dbg(JSON.stringify({ server: 'local', sample: { success: true, otpauth } }, null, 2));

      // update QR when email field changes (avoid revealing secret)
      el('email').addEventListener('input', () => {
        const e = el('email').value.trim() || 'user@example.com';
        currentEmail = e;
        setQRFromOtpAuth(buildOtpAuth(currentSecret, e));
      });

      // Complete setup handler
      el('completeBtn').addEventListener('click', async () => {
        hideAlerts();
        el('completeBtn').disabled = true;
        const email = (el('email').value || '').trim().toLowerCase();
        const question = el('question').value || '';
        const answer = (el('answer').value || '').trim();
        const code = (el('otpInput').value || '').trim();

        if (!email) { showErr('Please enter your email.'); el('completeBtn').disabled = false; return; }
        if (!code) { showErr('Please enter the 6-digit code from your authenticator app.'); el('completeBtn').disabled = false; return; }
        if (!question || !answer) { showErr('Please select a security question and provide an answer.'); el('completeBtn').disabled = false; return; }

        try {
          // 1) Save security setup (saves totpSecret + question on server)
          const saveResp = await fetch(`${API_BASE}/security/setup`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email, question, answer, totpSecret: currentSecret })
          });

          if (!saveResp.ok) {
            const err = await saveResp.json().catch(()=>({error:'Server error'}));
            showErr(err.error || err.message || `Save failed (status ${saveResp.status})`);
            el('completeBtn').disabled = false;
            return;
          }

          const saveJson = await saveResp.json().catch(()=>({success:false}));
          if (!saveJson || !saveJson.success) {
            showErr(saveJson.error || saveJson.message || 'Could not save security setup.');
            el('completeBtn').disabled = false;
            return;
          }

          // 2) Verify the first TOTP code now that server has secret
          const vResp = await fetch(`${API_BASE}/verify-totp`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ email, code })
          });

          const vJson = await vResp.json().catch(()=>({valid:false}));
          if (vJson && vJson.valid) {
            showOk('Security setup saved. TOTP confirmed. Redirecting...');
            // optionally remove pendingEmail and redirect to login or dashboard
            sessionStorage.removeItem('pendingEmail');
            setTimeout(()=> { window.location.href = 'signin.html'; }, 1000);
            return;
          } else {
            showErr('OTP verification failed. Make sure you scanned the QR and entered the current code.');
            // Note: server already stored the secret — user can retry verification or re-scan & re-run
            dbg(JSON.stringify({ serverResponse: vJson }, null, 2));
            el('completeBtn').disabled = false;
            return;
          }
        } catch (e) {
          console.error(e);
          showErr('Network or server error while saving setup. Ensure backend is running and CORS allows requests.');
          el('completeBtn').disabled = false;
        }
      });
    });
  </script>
</body>
</html>
